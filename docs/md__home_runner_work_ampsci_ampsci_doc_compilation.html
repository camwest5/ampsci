<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ampsci: Compilation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="./MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<!-- ... other metadata & script includes ... -->
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript">
    DoxygenAwesomeDarkModeToggle.init()
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ampsci
   </div>
   <div id="projectbrief">c++ program for high-precision atomic structure calculations of single-valence systems</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Compilation </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>brief Compilation instructions for Linux, Mac, and Windows</p>
<ul>
<li>Easiest method is to use provided shell scripts <code>install-dependencies.sh</code> (which installs the required packages/compilers), and <code>setup.sh</code> (which compiles ampsci)<ul>
<li>These might not work on all systems, meaning a manual setup will be required.</li>
</ul>
</li>
<li>You can also compile using the provided Makefile:</li>
<li>Copy "doc/examples/Makefile" from doc/ directory to the working directory<ul>
<li><code>cp ./doc/examples/Makefile ./</code></li>
</ul>
</li>
<li>All programs compiled using the Makefile (run <code>make</code>)</li>
<li>The file <em>Makefile</em> has some basic compilation options. It's currently set up to work on most linux systems; you may need to change a few options for others (see below)</li>
<li>Tested with g++ and clang++ on linux and mac</li>
</ul>
<h1>Dependencies / Requirements</h1>
<ul>
<li>c++ compiler that supports c++17<ul>
<li>Tested with clang version 6 and newer; gcc version 7 and newer</li>
<li>Also tested with Intel [icc 2021.9.0], though this is tested infrequently</li>
</ul>
</li>
<li>LAPACK and BLAS libraries <a href="http://www.netlib.org/lapack/">netlib.org/lapack/</a></li>
<li>GSL (GNU scientific libraries) <a href="https://www.gnu.org/software/gsl/">gnu.org/software/gsl/</a> [version 2.0 or newer*]<ul>
<li>(it <em>should</em> also work with older versions of GSL, but this is not regularly tested and therefore not guaranteed)</li>
<li>Updated to work with newer GSL version 2.8; still works with older versions too</li>
</ul>
</li>
<li>[optional] GNU Make (<a href="https://www.gnu.org/software/make/">gnu.org/software/make/</a>) - used to compile code</li>
<li>[optional] OpenMP (<a href="https://www.openmp.org/">openmp.org/</a>) - used for parallelisation</li>
<li>[optional] git (<a href="https://git-scm.com/">git-scm.com/</a>) for version tracking and to keep up-to-date with latest version</li>
</ul>
<h1>Quick-start</h1>
<p>This is for ubuntu/linux - for other systems, see below</p>
<ul>
<li>Get the code from <a href="https://github.com/benroberts999/ampsci">GitHub</a>, using git:<ul>
<li><code>sudo apt install git</code></li>
<li><code>git clone git@github.com:benroberts999/ampsci.git</code></li>
<li>or <code>git clone <a href="https://github.com/benroberts999/ampsci.git">https://github.com/benroberts999/ampsci.git</a></code></li>
</ul>
</li>
<li>Or, direct download (without using git, not recommended):<ul>
<li><a href="https://github.com/benroberts999/ampsci/archive/refs/heads/main.zip">https://github.com/benroberts999/ampsci/archive/refs/heads/main.zip</a></li>
</ul>
</li>
<li>Install dependencies<ul>
<li><code>sudo apt install g++ liblapack-dev libblas-dev libgsl-dev make libomp-dev</code></li>
</ul>
</li>
<li>Prepare the Makefile (already setup for ubuntu, you may need minor adjustments, see below)<ul>
<li><code>cp ./doc/examples/Makefile ./</code></li>
</ul>
</li>
<li>Compile ampsci using all default options: <br  />
<ul>
<li><code>make</code></li>
</ul>
</li>
<li>Run the first example program<ul>
<li><code>cp ./doc/examples/ampsci.in ./</code></li>
<li><code>./ampsci ampsci.in</code></li>
</ul>
</li>
</ul>
<hr  />
<h1>Compilation: Linux</h1>
<ul>
<li>Instructions for ubuntu; similar commands for other flavours</li>
<li>Install make: <code>sudo apt-get install make</code></li>
<li>Install GSL libraries: <code>sudo apt-get install libgsl-dev</code></li>
<li>May also need LAPACK/BLAS libraries: <code>sudo apt-get install libatlas-base-dev liblapack-dev libblas-dev</code></li>
<li>Install the compiler: <code>sudo apt-get install g++</code> and/or <code>sudo apt-get install clang++</code></li>
<li>Then compile by running <code>make</code> from the ampsci directory</li>
<li>To use with openMP (for parallelisation) with clang++, you might have to also install clang openmp libraries: <code>sudo apt install libomp5</code> (and/or perhaps <code>sudo apt install libomp-dev</code>)</li>
</ul>
<h1>Compilation: MacOS (intel chip)</h1>
<ul>
<li>On mac: use <em>homebrew</em> to install gsl: <em>brew install gsl</em></li>
<li><em>homebrew</em> is a package manager; install from <a href="https://brew.sh/">https://brew.sh/</a></li>
<li>Seems to work best with the homebrew version of gcc. Install as: <code>brew install gcc</code></li>
<li>Note: you may need to change the compiler from <code>g++</code> to <code>g++-9</code> (or similar), or update your environment variables, since calling g++ on mac actually calls clang++ by default</li>
<li>You might have to tell the compiler how to link to the GSL library; in Makefile:<ul>
<li>PathForGSL=/usr/local/opt/gnu-scientific-library</li>
</ul>
</li>
<li>Then compile by running <em>make</em> from the ampsci directory</li>
<li>Use openMP for parellelisation when using clang++ on mac:<ul>
<li>If using g++, should work as per normal</li>
<li>To use openMP with clang, seem to require the llvm version</li>
<li><em>brew install llvm</em></li>
<li>Then, in the Makefile, set (exact paths may be different for you):<ul>
<li>CXX=/usr/local/opt/llvm/bin/clang++</li>
<li>ExtraInclude=/usr/local/opt/llvm/include/</li>
<li>ExtraLink=/usr/local/opt/llvm/lib/</li>
</ul>
</li>
<li>This seems fragile</li>
</ul>
</li>
</ul>
<h1>Compilation: MacOS (M1/M2/apple silicon chip)</h1>
<ul>
<li>Mostly the same as above, but some of the libraries are installed to different directories by default. In particular:</li>
<li>PathForGSL=/opt/homebrew/Cellar/gsl/2.7</li>
</ul>
<h1>Compilation: Windows</h1>
<ul>
<li>For windows, the easiest way (for me, anyway) is to use the 'windows subsystem for linux' (requires Windows 10+).</li>
<li>Instructions on installation/use here: <a href="https://docs.microsoft.com/en-us/windows/wsl/install">docs.microsoft.com/en-us/windows/wsl/install</a>.</li>
<li>Then, the compilation + use can proceed as per Linux above.</li>
</ul>
<hr  />
<h1>Common Compilation errors</h1>
<h2>libgfortran error</h2>
<p>Error linking to gfortran/lapack, may be something like this:</p>
<p>ld: .../liblapack.a(xerbla.o): undefined reference to symbol '_gfortran_string_len_trim@GFORTRAN_8' ld: .../libgfortran.so.5: error adding symbols: DSO missing from command line make: *** [build/buildTargets.mk:66: ampsci] Error 1</p>
<p>Sometimes occurs on certain systems (e.g., bunya). In these cases, the fortran libraries need to be linked to explicitely. This can be done by adding <code>-lgfortran</code> to the <code>ExtraFlags</code> option in the Makefile</p>
<div class="fragment"><div class="line">ExtraFlags=-lgfortran</div>
</div><!-- fragment --><h2>OpenMP errors</h2>
<ul>
<li><b>error: unsupported option -fopenmp</b></li>
<li><b>error: could not find &lt;omp.h&gt;</b></li>
<li>openmp (used for parallelisation) is not working. See above for some possible solutions.</li>
<li>Quick fix: change '<em>UseOpenMP=yes</em>' to '<em>UseOpenMP=no</em>' in Makefile</li>
</ul>
<h2>GSL Errors</h2>
<ul>
<li><b>fatal error: gsl/&lt;...&gt;.h: No such file or directory</b> (or similar)</li>
<li><b>gsl</b> related linking/compilation error:</li>
<li>Could not find required GSL libraries. Either they are not installed, or you need to link to them</li>
<li>1) Ensure GSL is installed (see above for instructions)</li>
<li>2) If GSL library is not installed in _/usr/local/_, you have to tell the compiler where to find the GSL files. Do this by setting the <em>PathForGSL</em> option in Makefile. Common examples:<ul>
<li><em>PathForGSL=/opt/gsl/2.1/gnu</em> # For UQ's getafix cluster</li>
<li><em>PathForGSL=/usr/local/opt/gnu-scientific-library</em> # For my macbook</li>
<li>Note: the exact path may differ for you, depending on where GSL was installed</li>
</ul>
</li>
<li><b>error: too few arguments to function â€˜int gsl_bspline_deriv_eval</b></li>
<li>This is because the code is linking to a very old version of GSL. You might need to update GSL. If you have updated GSL (to at least version 2.0) and still get the message, the code is probably linking against the wrong version of GSL; see above to point the compiler to the correct version</li>
</ul>
<h2>ld: Assertion failed: (resultIndex &lt; sectData.atoms.size())</h2>
<p>Full error message may look something like:</p>
<div class="fragment"><div class="line">0  0x102497648  __assert_rtn + 72</div>
<div class="line">1  0x1023cbfac  ld::AtomPlacement::findAtom(unsigned char, unsigned long long, ld::AtomPlacement::AtomLoc const*&amp;, long long&amp;) const + 1204</div>
<div class="line">2  0x1023e1924  ld::InputFiles::SliceParser::parseObjectFile(mach_o::Header const*) const + 15164</div>
<div class="line">3  0x1023eee30  ld::InputFiles::parseAllFiles(void (ld::AtomFile const*) block_pointer)::$_7::operator()(unsigned long, ld::FileInfo const&amp;) const + 420</div>
<div class="line">4  0x185a37950  _dispatch_client_callout2 + 20</div>
<div class="line">5  0x185a4aba0  _dispatch_apply_invoke + 176</div>
<div class="line">6  0x185a37910  _dispatch_client_callout + 20</div>
<div class="line">7  0x185a493cc  _dispatch_root_queue_drain + 864</div>
<div class="line">8  0x185a49a04  _dispatch_worker_thread2 + 156</div>
<div class="line">9  0x185be10d8  _pthread_wqthread + 228</div>
<div class="line">ld: Assertion failed: (resultIndex &lt; sectData.atoms.size()), function findAtom, file Relocations.cpp, line 1336.</div>
<div class="line">collect2: error: ld returned 1 exit status</div>
</div><!-- fragment --><ul>
<li>This seems to be a bug with M1/M2 mac linker implementation with CommandLineTools version 15.0 (see <a href="https://developer.apple.com/forums/thread/737707">developer.apple.com/forums/thread/737707</a>)</li>
<li>See also: <a href="https://github.com/Homebrew/homebrew-core/issues/145991">github.com/Homebrew/homebrew-core/issues/145991</a></li>
<li>This issue seems to have been resolved in version 15.1 - so run an update if you can.</li>
<li>If you can't update, it seems this can be fixed by adding the following to the Makefile:</li>
</ul>
<div class="fragment"><div class="line">LARGS=-Wl,-ld_classic</div>
</div><!-- fragment --><p>You shouldn't need to make clean first, but if it doesn't work, try that too.</p>
<h2>Others</h2>
<ul>
<li>Sometimes, the compiler will not be able to find the correct libraries (particular, e.g., on clusters). In this case, there are two options in the Makfefile: <b>ExtraInclude</b> and <b>ExtraLink</b><ul>
<li>These add paths to include the correct directories for both -I "includes" (for compilation), and -L link flags (for linking libraries) in Makefile. These can be a little tricky to get right (don't include the -I or -L) </li>
</ul>
</li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Fri Jul 12 2024 07:43:56 for ampsci by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
